{% extends 'base.html.twig' %}
{% block title %}Chat con {{ otherUser.nombre }}{% endblock %}
{% block body %}

<!-- Header del chat -->
<div class="chat-header">
    <a href="{{ path('app_chat_index') }}" class="chat-back">â€¹</a>
    <a href="{{ path('app_usuario_perfil', {id: otherUser.id}) }}" class="chat-header-user">
        <img src="{{ otherUser.fotoPerfil ? asset('uploads/perfiles/' ~ otherUser.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}"
             alt="{{ otherUser.nombre }}"
             class="chat-header-avatar">
        <div class="chat-header-info">
            <span class="chat-header-nombre">{{ otherUser.nombre }}</span>
            <span class="chat-header-estado">Ver perfil</span>
        </div>
    </a>
</div>

<!-- Mensajes -->
<div class="chat-mensajes" id="chat-mensajes">
    {% for message in messages %}
        {% set isMe = message.remitente.id == app.user.id %}

        <div class="mensaje-fila {{ isMe ? 'mensaje-mio' : 'mensaje-suyo' }}">

            {% if not isMe %}
                <img src="{{ message.remitente.fotoPerfil ? asset('uploads/perfiles/' ~ message.remitente.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}"
                     alt="{{ message.remitente.nombre }}"
                     class="mensaje-avatar">
            {% endif %}

            <div class="mensaje-burbuja {{ isMe ? 'burbuja-mia' : 'burbuja-suya' }}">

                {% if message.palabraCompartida %}
                    {% set sharedPost = message.palabraCompartida %}
                    <a href="{{ path('palabra_show', {id: sharedPost.id}) }}" class="mensaje-compartido">
                        <div class="compartido-header">
                            <img src="{{ sharedPost.usuario.fotoPerfil ? asset('uploads/perfiles/' ~ sharedPost.usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}"
                                 alt="{{ sharedPost.usuario.nombre }}"
                                 class="compartido-avatar">
                            <span class="compartido-autor">{{ sharedPost.usuario.nombre }}</span>
                        </div>
                        <div class="compartido-body">
                            <p class="compartido-palabra">{{ sharedPost.palabra }}</p>
                            <p class="compartido-definicion">{{ sharedPost.definicion|slice(0, 60) }}{% if sharedPost.definicion|length > 60 %}...{% endif %}</p>
                        </div>
                    </a>
                {% endif %}

                {% if message.contenido %}
                    <p class="mensaje-texto">{{ message.contenido }}</p>
                {% endif %}

                <span class="mensaje-hora">{{ message.fechaEnvio|date('H:i') }}</span>
            </div>

        </div>

    {% else %}
        <div class="chat-vacio">
            <span class="chat-vacio-emoji"></span>
            <p class="chat-vacio-texto">Di hola a <strong>{{ otherUser.nombre }}</strong></p>
        </div>
    {% endfor %}
</div>

<!-- Input de mensaje -->
<div class="chat-input-wrapper">
    <form action="{{ path('app_chat_send', {id: otherUser.id}) }}" method="post" class="chat-form">
        <input type="text"
               name="content"
               class="chat-input"
               placeholder="Escribe un mensaje..."
               required
               autofocus
               autocomplete="off">
        <button type="submit" class="chat-send-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </form>
</div>

<script>
    const chatContainer = document.getElementById('chat-mensajes');
    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
</script>

{% endblock %}