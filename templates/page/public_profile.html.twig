{% extends 'base.html.twig' %}
{% block title %}
	{{ usuario.nombre }}
	- Instalabra
{% endblock %}

{% block body %}
	<main
		class="feed" data-user-id="{{ usuario.id }}">
		<!-- HEADER DEL PERFIL PÚBLICO -->
		<section class="foto-perfil">
			<div class="profile-header">
				<img class="profile-picture" src="{{ usuario.fotoPerfil ? asset('uploads/perfiles/' ~ usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="Foto de {{ usuario.nombre }}">
				<div class="profile-info">
					<h2>{{ usuario.nombre }}</h2>
					{% if usuario.biografia %}
						<p class="bio">{{ usuario.biografia }}</p>
					{% else %}
						<p class="bio bio-empty">Este usuario aún no tiene biografía</p>
					{% endif %}
				</div>
			</div>

			<!-- ESTADÍSTICAS -->
			<div class="profile-stats">
				<div class="stat-item">
					<strong>{{ palabras|length }}</strong>
					<span>Palabras</span>
				</div>
				<div class="stat-item followers" onclick="openFollowers()">
					<strong class="js-followers-count">{{ followersCount }}</strong>
					<span>Seguidores</span>
				</div>
				<div class="stat-item following" onclick="openFollowing()">
					<strong>{{ followingCount }}</strong>
					<span>Seguidos</span>
				</div>
			</div>

			<!-- ACCIONES DEL PERFIL -->
			{% if app.user and app.user != usuario %}
				<div class="profile-actions">

					{# Seguir / Siguiendo #}
					<a href="{{ path('app_usuario_follow', {id: usuario.id}) }}"
					   class="ajax-follow-link" data-turbo="false">
						<button class="{{ isFollowing ? 'btn-following' : 'btn-follow' }}">
							{{ isFollowing ? 'Siguiendo' : 'Seguir' }}
						</button>
					</a>

					{# Mensaje #}
					<a href="{{ path('app_chat_show', {id: usuario.id}) }}">
						<button class="btn-message">Enviar mensaje</button>
					</a>

					{# Bloquear / Desbloquear #}
					<a href="{{ path('admin_user_toggle_block', {id: usuario.id}) }}"
					   class="ajax-follow-link" data-turbo="false">
						<button class="btn-admin {{ usuario.isBlocked ? 'btn-unblock' : 'btn-block' }}">
							{{ usuario.isBlocked ? 'Desbloquear' : 'Bloquear' }}
						</button>
					</a>

				</div>
			{% endif %}
		</section>


		<!-- TABS DE NAVEGACIÓN -->
		<div class="profile-tabs">
			<button class="tab-button active">Palabras</button>
		</div>

		<!-- POSTS DEL USUARIO -->
		<div class="profile-posts">
			{% if palabras|length > 0 %}
				{% for palabra in palabras %}
					<section class="single_post">
						<div class="post_header">
							<div class="user_info">
								<img src="{{ usuario.fotoPerfil ? asset('uploads/perfiles/' ~ usuario.fotoPerfil) : asset('multimedia/Prueba/noicon.jpg') }}" alt="Foto de {{ usuario.nombre }}">
								<div class="user_details">
									<span class="user_name">{{ usuario.nombre }}</span>
									<small class="post_time">{{ palabra.fechaCreacion|date('d M Y · H:i') }}</small>
								</div>
							</div>
						</div>

						<div class="post_content">
							<p class="palabra-title">
								<a href="{{ path('palabra_show', {id: palabra.id}) }}">{{ palabra.palabra }}</a>
							</p>
							<p class="palabra-definition">{{ palabra.definicion }}</p>
						</div>

						<div
							class="post-actions">
							<!-- LIKE -->
							<div class="action like-action">
								{% if app.user %}
									<form action="{{ path('palabra_like_toggle', {'id': palabra.id}) }}" method="post" class="ajax-like-form">
										{% set liked = palabra.valoraciones|filter(v => v.usuario.id == app.user.id and v.likeActiva)|length %}
										<button type="submit" class="action-btn {{ liked ? 'liked' : '' }}">
											<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta">
											<span class="count">{{ palabra.valoraciones|filter(v => v.likeActiva)|length }}</span>
										</button>
									</form>
								{% else %}
									<img src="{{ asset('multimedia/like.png') }}" alt="Me gusta">
									<span class="count">{{ palabra.valoraciones|filter(v => v.likeActiva)|length }}</span>
								{% endif %}
							</div>

							<!-- COMENTARIOS -->
							<div class="action comment-action" onclick="window.location.href='{{ path('palabra_show', {id: palabra.id}) }}'">
								<img src="{{ asset('multimedia/comment.png') }}" alt="Comentar">
								<span class="count">{{ palabra.activeComentariosCount }}</span>
							</div>
						</div>
					</section>
				{% endfor %}
			{% else %}
				<div class="empty-state">
					<div class="empty-icon"></div>
					<p class="empty-title">{{ usuario.nombre }}
						aún no ha publicado palabras</p>
					<p class="empty-subtitle">Cuando lo haga, aparecerán aquí</p>
				</div>
			{% endif %}
		</div>

		<!--Ventana para ver los followers de la persona-->
		{% include 'components/_followers.html.twig' with {
        titulo: 'Seguidores',
        lista: usuario.seguimientosQueRecibe|map(s => s.seguidor)
    } %}

		<!--Ventana para ver los following de la persona-->
		{% include 'components/_following.html.twig' with {
		titulo: 'Seguidos',
		lista: usuario.seguimientosQueHace|map(s => s.seguido)
	} %}
	</main>
{% endblock %}
